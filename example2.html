<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>Example</title>

    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false" type="text/javascript"></script>
    <script src="GSVPanoDepth.js/examples/js/jquery.min.js" type="text/javascript"></script>
    <script src="GSVPanoDepth.js/examples/js/jquery.base64.min.js" type="text/javascript"></script>
    <script src="GSVPanoDepth.js/examples/js/zpipe.min.js" type="text/javascript"></script>
    <script src="GSVPanoDepth.js/examples/js/GSVPano.js" type="text/javascript"></script>
    <script src="GSVPanoDepth.js/src/GSVPanoDepth.js" type="text/javascript"></script>
    <script>
      // var intersection = new google.maps.LatLng(40.721770, -73.997641);
      var intersection = new google.maps.LatLng(40.7210690835, -73.9981985092);

      function initDepthMap() {
        var _panoLoader = new GSVPANO.PanoLoader({zoom: 1}),
            _depthLoader = new GSVPANO.PanoDepthLoader();

        _depthLoader.onDepthLoad = function() {
          var x, y, canvas, context, image, w, h, c;

          canvas = document.createElement("canvas");
          context = canvas.getContext('2d');

          w = this.depthMap.width;
          h = this.depthMap.height;

          canvas.setAttribute('width', w);
          canvas.setAttribute('height', h);

          image = context.getImageData(0, 0, w, h);

          for(y=0; y<h; ++y) {
            for(x=0; x<w; ++x) {
              c = this.depthMap.depthMap[y*w + x] / 150 * 255;
              image.data[4*(y*w + x)    ] = c;
              image.data[4*(y*w + x) + 1] = c;
              image.data[4*(y*w + x) + 2] = c;
              image.data[4*(y*w + x) + 3] = 255;
            }
          }

          context.putImageData(image, 0, 0);

          gContext = context;
          gDepthMap = this.depthMap;

          gImageData = image;

          document.getElementById('depth').appendChild(canvas);
        }

        _panoLoader.onPanoramaLoad = function() {
          document.getElementById('pano2').appendChild(this.canvas);
          _depthLoader.load(this.panoId);
        };

        _panoLoader.load(intersection);
      }


      function initialize() {
        // Init the depth map
        initDepthMap();

        // More robust to do all of this AFTER the depth map is created.
        var panoramaOptions = {
              addressControl: false,
              clickToGo: false,
              scrollwheel: false,
              linksControl: false,
              disableDoubleClickZoom: false,
              zoomControlOptions: {
                style: google.maps.ZoomControlStyle.SMALL
              },
              position: intersection,
              pov: {
                heading: 0,
                pitch: 0
              },
              visible: true
            },
            panorama = new google.maps.StreetViewPanorama(document.getElementById('pano'), panoramaOptions),
            marker = new google.maps.Marker({
              position: new google.maps.LatLng(40.72121352779235, -73.99819750679717),
              map: panorama,
              icon: 'marker-plus-shadowed.png',
              // icon: 'http://visionzero-dev.herokuapp.com/static/css/images/markers/icon-dot-yield.png',
              title: 'Add a new report'
            });


        google.maps.event.addListener(panorama, 'pov_changed', function() {
          var pov = panorama.getPov(),
              heading = pov.heading,
              pitch = pov.pitch,
              max = 100, min = 5,
              x, y, dist, pitchDist;
            // console.log('pov_changed: heading', heading);
            // console.log('pov_changed: pitch', pitch);

          pitch = (90 - pitch) / 180;
          heading = (-heading+30) / 360;

          y = Math.round(pitch * (gDepthMap.height - 1));
          x = Math.round(heading * (gDepthMap.width - 1));

          dist = gDepthMap.depthMap[y*gDepthMap.width + x];

          if (dist > max) {
            dist = max;
          }

          pitchDist = Math.pow((1-pitch)* 4, 4);

          if (pitchDist < min) {
            pitchDist = min;
          }

          var ll = google.maps.geometry.spherical.computeOffsetOrigin(intersection, pitchDist, pov.heading-180);

          marker.setPosition(ll);

          index = (x + y * gDepthMap.width) * 4;
          gImageData.data[index+0] = 255;
          gImageData.data[index+1] = 0;
          gImageData.data[index+2] = 0;
          gImageData.data[index+3] = 255;

          gContext.putImageData(gImageData, 0, 0);
        });
      }

      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>
<body>
    <div id="pano" style="width:1000px; height:500px;"></div>
    <div id="depth" style="display:none;"></div>
    <div id="pano2" style="display:none;"></div>
</body>
</html>
